pipeline {
    agent any

    environment {
        AWS_CREDENTIALS = 'aws-credentials-id'  
    }

    stages {

        stage('Initialize Terraform') {
            steps {
                // Initialize the Terraform project
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: AWS_CREDENTIALS]]) {
                    sh 'terraform init -reconfigure'
                }
            }
        }

         stage('Format Terraform') {
            steps {
                // Generate and review the plan for deploying resources
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: AWS_CREDENTIALS]]) {
                    sh 'terraform fmt'
                }
            }
        }

         stage('Validate Terraform') {
            steps {
                // Generate and review the plan for deploying resources
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: AWS_CREDENTIALS]]) {
                    sh 'terraform validate'
                }
            }
        }

        stage('Plan Terraform') {
            steps {
                // Generate and review the plan for deploying resources
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: AWS_CREDENTIALS]]) {
                    sh 'terraform plan -out=tfplan'
                }
            }
        }

        stage('Apply Terraform') {
            steps {
                // Apply the Terraform plan
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: AWS_CREDENTIALS]]) {
                    sh 'terraform apply -auto-approve tfplan'
                }
            }
        }

        stage('Post Deployment Steps') {
            steps {
                echo "Terraform deployment complete."
            }
        }
    }
}
